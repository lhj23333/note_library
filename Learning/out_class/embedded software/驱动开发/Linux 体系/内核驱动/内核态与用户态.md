---
share_link: https://share.note.sx/20abec99#zGJptm73238AGA9LC7ua5y3qfDI3ogQU21DfwCmj4YY
share_updated: 2025-02-13T16:45:16+08:00
---
### 1. 内核态和用户态

- 在操作系统中，用户态和内核态是两种不同的执行模式，用来确保计算机资源的安全性、稳定性和高效性。
#### 1.1 内核态：

- 内核态是操作系统核心部分的运行模式，它拥有完全的访问权限，能够直接操作硬件，管理内存以及执行指令
- 特点
	- 权限最高：内核可以直接访问所有硬件资源、内存、进程调度，任何操作不受限制
	- 切换代价高：从用户态切换到内核态需要保存当前状态、加载内核相关信息，这个过程通常会涉及较高的开销。

#### 1.2 用户态：

- 用户态是程序运行的普通模式，应用程序在此模式下执行，此时，程序的访问权限受到严格限制，不能直接访问硬件资源和内核资源
- 特点：
	- 权限受限：程序不能直接访问内存中操作系统内核的资源和硬件设备。当用户程序需要这些资源时，必须通过系统调用来请求内核的接管
	- 进程隔离：每个用户程序运行在自己的内存空间中，不会直接干扰其他程序
	- 效率较低：由于用户态程序不能直接调用内核和硬件资源，需要通过系统调用以及中断等机制进行上下文的切换

### 2. 内核线程与用户线程
#### 2.1 内核线程：

- 由操作系统内核创建、管理和销毁的线程。这些线程在内核空间中运行，并由操作系统内核调度与管理。
- 内核进程的执行是由操作系统内核直接控制的，它们可以直接访问系统资源（如硬件、内存、I/O 设备等）
- 内核线程的创建与销毁：
	- 创建：内核线程的创建通常是由操作系统内核在处理某些系统任务是自动进行的。例如，当系统需要进行某些后台操作（如设备驱动程序、文件系统的管理等）时，操作系统会为这些任务分配一个内核线程。**这些线程并不是由用户程序直接创建的，而是操作系统根据系统需求动态创建的**。
	- 销毁：内核线程的销毁通常是当其任务完成或系统不再需要时进行的。操作系统会回收内核线程的资源，并将其从调度队列中移除

> [!NOTE] 内核线程的调度
> 内核线程通常会受到操作系统内核调度器的管理，调度器依据一定的策略（如优先级、时间片等）决定哪个内核线程获得 CPU 执行的时间
> 
> 内核线程的调度独立于用户线程，内核线程的调度与用户线程的调度是相互独立的。

> [!Tip] 多线程的并发性
> 在操作系统中，**进程** 是系统资源分配的基本单位，而 **线程** 是程序执行的基本单位。在 **单进程多线程模型** 中，一个进程可以包含多个线程，一个进程至少拥有一个 CPU 核心。现代操作系统支持多核处理器，可以同时运行多个线程，从而实现并发。
> - 多核处理器的并发性：
> 	- 在**多核处理器**中，操作系统可以将进程中的不同线程分配到不同的 CPU 核心上执行，这样多个线程可以 **真正并行** 地运行。每个线程在独立的 CPU 核心上执行时，它们彼此之间的执行互不干扰。
> - 单核处理器的并发性：
> 	- 尽管**单核处理器**物理上只有一个核心来执行线程，但操作系统通过时间片轮转（`Time Slice`）机制来实现并发，具体来说：
> 		- 操作系统为美国线程分配一个时间片，每个线程在自己的时间片内执行一定的时间量
> 		- 当某个线程的时间片耗尽时，操作系统会中断该线程，转向执行其他线程（上下文切换），每个线程的状态（如寄存器、程序计数器、栈指针等）会被保存，以便下次恢复时继续执行。

#### 2.2 用户线程：

- 用户线程是完全在用户态中实现的，不依赖操作系统内核的线程管理。
- 线程的创建、同步、调度等操作都依赖用户态的线程库（`pthread` 线程库）提供的 API来完成，在应用程序内部进行管理和调度，而不依赖于操作系统的内核线程

> [!NOTE] 用户态线程管理调度系统
> 用户线程库内部会实现一个类似于调度器的机制，包括：
> - 线程创建（分配线程控制块 `TCB`）
> - 线程调度（决定哪个线程执行）
> - 线程同步  (协调多个线程对共享资源访问)
> - 线程销毁（释放线程资源）

- 由于用户线程的管理完全在用户态中进行，不涉及内核态的线程调度，因此切换时不需要进行用户态/内核态的转换，减少了上下文切换的开销

> [!Tip] 
> 由于用户线程的管理完全在用户态中进行，同时内核只知道用户进程，不知道用户进程内部的多个线程，所以操作系统内核并不知道用户线程的存在，它仍然是按照进程来分配 CPU 资源，不会给这些用户线程单独分配 CPU 时间
> 
> 且当用户线程发生阻塞（例如 I/O 操作）时，整个进程都会被阻塞，即使进程中其他线程仍可继续运行，但无法执行


### 3. 内核进程和用户进程：

#### 3.1 内核进程：
**定义：**
- 内核进程（Kernel Process）是操作系统内核创建和管理的特殊进程，通常用于执行和系统相关的任务，例如进程调度、内存管理、设备驱动程序、文件系统管理。

**特点：**
- 内核进程运行在内核态，拥有对硬件和系统资源的完全控制权，可以直接访问 CPU、内存、磁盘、设备等硬件资源
- 内核进程不会直接由用户创建，而是操作系统自己创建和管理，一般在系统启动时就会初始化。
- 内核进程也会被调度，但通常优先级高于普通用户进程，以确保操作系统的关键功能不会被延迟。

> [!Tip] 内核进程与内核线程
> - 内核线程：是运行在内核态的线程，但它可能属于用户进程的内核线程（如多线程程序的内核级线程）
> - 内核进程：是独立进程，不属于任何应用，它本身就由内核创建，用于执行系统级任务

**作用：**
- 进程管理：
	- 负责创建、调度、终止进程
	- 通过调度器绝对哪个进程/线程获得 CPU 时间
- 内存管理：
	- 负责分配、回收物理内存，实现虚拟内存
- 文件系统管理：
	- 处理文件读取、写入、权限管理
	- 管理文件系统以及磁盘 I/O 操作
- 设备管理：
	- 控制设备驱动程序，运行操作系统与硬件进行交互
		- 磁盘驱动
		- 设备驱动
- 网络协议栈：
	- 处理网络数据包的收发，管理 `TCP/IP` 协议栈

#### 3.2 用户进程：

- 用户进程是指操作系统中由普通用户启动并运行的程序。是操作系统中最基本的独立执行单元，属于用户空间的一部分。通常由操作系统提供的各种工具、库和接口来管理和调度。
- 每个用户进程都有自己的虚拟内存空间，在这个空间内，进程可以执行其代码并访问器所拥有的数据（例如：全局变量、堆、栈等）
- 操作系统通过进程管理来负责进程的生命周期，包括创建、调度、同步、通信和终止等
- 特点：
	- 资源隔离：每个用户进程在操作系统中拥有独立的虚拟内存空间，互不干扰。
	- 执行权限：用户进程在执行时拥有较低的权限（即“用户态”），不能直接访问系统资源（如硬件和操作系统内核）

#### 3.3 二者联系：

用户进程与操作系统内核进程（如设备驱动、内存管理等）是相互隔离的，它们分别运行在 **用户态** 和 **内核态** 下。用户进程的代码运行在 **用户态**，而在需要访问硬件或操作系统资源时，它通过系统调用进入 **内核态**。

